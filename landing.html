<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinFlow â€” Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
:root {
  --bg: #080b12;
  --s1: #0e1420;
  --s2: #141b2a;
  --s3: #1a2235;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.13);
  --text: #f0f4ff;
  --text2: #8899bb;
  --text3: #4a5a78;
  --accent: #6c8dfa;
  --accent2: #4ecca3;
  --red: #ff6b6b;
  --grad: linear-gradient(135deg, #6c8dfa, #4ecca3);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);font-family:'DM Sans',sans-serif;color:var(--text);overflow:hidden;}

/* â”€â”€ Background â”€â”€ */
.bg-canvas {
  position:fixed;inset:0;z-index:0;overflow:hidden;
}
.bg-orb {
  position:absolute;border-radius:50%;filter:blur(80px);opacity:0.15;animation:orbFloat 8s ease-in-out infinite;
}
.bg-orb-1{width:500px;height:500px;background:#6c8dfa;top:-100px;left:-100px;animation-delay:0s;}
.bg-orb-2{width:400px;height:400px;background:#4ecca3;bottom:-80px;right:-80px;animation-delay:-3s;}
.bg-orb-3{width:300px;height:300px;background:#b197fc;top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:-5s;}
.bg-grid {
  position:absolute;inset:0;
  background-image:linear-gradient(rgba(108,141,250,0.04) 1px, transparent 1px),
                   linear-gradient(90deg, rgba(108,141,250,0.04) 1px, transparent 1px);
  background-size:48px 48px;
}
@keyframes orbFloat {
  0%,100%{transform:translate(0,0) scale(1);}
  33%{transform:translate(30px,-20px) scale(1.05);}
  66%{transform:translate(-20px,30px) scale(0.95);}
}

/* â”€â”€ Layout â”€â”€ */
.page {
  position:relative;z-index:1;
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  padding:20px;overflow-y:auto;
}

/* â”€â”€ Card â”€â”€ */
.card {
  width:100%;max-width:420px;
  background:rgba(14,20,32,0.85);
  border:1px solid var(--border2);
  border-radius:24px;
  padding:40px 36px;
  backdrop-filter:blur(20px);
  box-shadow:0 32px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(108,141,250,0.08);
  animation:cardIn .5s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes cardIn {
  from{opacity:0;transform:translateY(24px) scale(0.97);}
  to{opacity:1;transform:translateY(0) scale(1);}
}

/* â”€â”€ Logo â”€â”€ */
.logo {
  display:flex;align-items:center;gap:10px;margin-bottom:32px;
}
.logo-dot {
  width:10px;height:10px;border-radius:50%;
  background:var(--grad);
  box-shadow:0 0 12px rgba(108,141,250,0.6);
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%,100%{box-shadow:0 0 12px rgba(108,141,250,0.6);}
  50%{box-shadow:0 0 20px rgba(108,141,250,0.9),0 0 40px rgba(108,141,250,0.3);}
}
.logo-text {
  font-family:'Syne',sans-serif;font-weight:800;font-size:22px;
  background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.logo-badge {
  font-size:10px;font-weight:600;color:var(--text3);
  border:1px solid var(--border2);border-radius:20px;padding:2px 8px;
  margin-left:auto;letter-spacing:.05em;text-transform:uppercase;
  -webkit-text-fill-color:var(--text3);
}

/* â”€â”€ Screen titles â”€â”€ */
.screen-title {
  font-family:'Syne',sans-serif;font-weight:700;font-size:22px;
  margin-bottom:6px;line-height:1.2;
}
.screen-sub {
  font-size:13px;color:var(--text2);margin-bottom:28px;line-height:1.5;
}

/* â”€â”€ Tabs â”€â”€ */
.tabs {
  display:flex;gap:4px;background:var(--s2);border-radius:12px;padding:4px;margin-bottom:28px;
}
.tab {
  flex:1;padding:9px;border-radius:9px;border:none;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .2s;color:var(--text2);background:none;
}
.tab.active {
  background:var(--s3);color:var(--text);
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
}

/* â”€â”€ Form â”€â”€ */
.form-group { margin-bottom:16px; }
.form-label {
  display:block;font-size:11px;font-weight:600;color:var(--text3);
  letter-spacing:.08em;text-transform:uppercase;margin-bottom:7px;
}
.form-input {
  width:100%;padding:13px 16px;
  background:var(--s2);border:1.5px solid var(--border);
  border-radius:12px;color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:14px;
  outline:none;transition:all .2s;
}
.form-input:focus { border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,141,250,0.1); }
.form-input::placeholder { color:var(--text3); }
.form-input.error { border-color:var(--red);box-shadow:0 0 0 3px rgba(255,107,107,0.1); }

.pass-wrap { position:relative; }
.pass-toggle {
  position:absolute;right:14px;top:50%;transform:translateY(-50%);
  background:none;border:none;cursor:pointer;color:var(--text3);font-size:16px;
  transition:color .2s;padding:4px;
}
.pass-toggle:hover { color:var(--text2); }

/* â”€â”€ Button â”€â”€ */
.btn-primary {
  width:100%;padding:14px;border-radius:12px;border:none;
  background:var(--grad);color:#fff;
  font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;
  cursor:pointer;transition:all .2s;
  box-shadow:0 4px 20px rgba(108,141,250,0.35);
  position:relative;overflow:hidden;
}
.btn-primary:hover { transform:translateY(-1px);box-shadow:0 8px 28px rgba(108,141,250,0.45); }
.btn-primary:active { transform:translateY(0); }
.btn-primary:disabled { opacity:.6;cursor:not-allowed;transform:none; }
.btn-primary .spinner {
  display:inline-block;width:16px;height:16px;
  border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;
  border-radius:50%;animation:spin .7s linear infinite;
  vertical-align:middle;margin-right:8px;
}
@keyframes spin{to{transform:rotate(360deg);}}

.btn-secondary {
  width:100%;padding:12px;border-radius:12px;
  background:none;border:1.5px solid var(--border2);color:var(--text2);
  font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;
  cursor:pointer;transition:all .2s;margin-top:8px;
}
.btn-secondary:hover { border-color:var(--accent);color:var(--text); }

/* â”€â”€ Error / Info â”€â”€ */
.err-box {
  background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.2);
  border-radius:10px;padding:10px 14px;font-size:13px;color:var(--red);
  margin-bottom:16px;display:none;line-height:1.4;
}
.info-box {
  background:rgba(78,204,163,0.08);border:1px solid rgba(78,204,163,0.2);
  border-radius:10px;padding:12px 14px;font-size:13px;color:var(--accent2);
  margin-bottom:16px;display:none;line-height:1.5;
}

/* â”€â”€ Divider â”€â”€ */
.divider {
  display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--text3);font-size:12px;
}
.divider::before,.divider::after { content:'';flex:1;height:1px;background:var(--border); }

/* â”€â”€ Forgot pass â”€â”€ */
.forgot {
  display:block;text-align:right;font-size:12px;color:var(--text3);
  text-decoration:none;margin-top:-8px;margin-bottom:16px;cursor:pointer;
  transition:color .2s;
}
.forgot:hover { color:var(--accent); }

/* â”€â”€ Screen management â”€â”€ */
.screen { display:none; }
.screen.active { display:block;animation:fadeIn .3s ease both; }
@keyframes fadeIn { from{opacity:0;transform:translateX(8px);} to{opacity:1;transform:translateX(0);} }

/* â”€â”€ Account setup â”€â”€ */
.avatar-row {
  display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;
}
.av-color {
  width:32px;height:32px;border-radius:9px;cursor:pointer;
  border:2px solid transparent;transition:all .2s;
}
.av-color.selected { border-color:#fff;transform:scale(1.1); }

/* â”€â”€ Verify screen â”€â”€ */
.verify-icon {
  font-size:48px;text-align:center;margin-bottom:16px;
  animation:bounce .6s ease infinite alternate;
}
@keyframes bounce { from{transform:translateY(0);} to{transform:translateY(-6px);} }

/* â”€â”€ Footer â”€â”€ */
.footer {
  text-align:center;font-size:11px;color:var(--text3);margin-top:24px;
}
.footer a { color:var(--text3);text-decoration:none; }
.footer a:hover { color:var(--text2); }
</style>
</head>
<body>

<div class="bg-canvas">
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>
  <div class="bg-grid"></div>
</div>

<div class="page">
<div class="card">

  <div class="logo">
    <div class="logo-dot"></div>
    <div class="logo-text">FinFlow</div>
    <div class="logo-badge">Beta</div>
  </div>

  <!-- â•â• SCREEN: LOGIN/REGISTER â•â• -->
  <div class="screen active" id="screenAuth">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('login')">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
      <button class="tab" onclick="switchTab('register')">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
    </div>

    <div id="errBox" class="err-box"></div>
    <div id="infoBox" class="info-box"></div>

    <!-- Login form -->
    <div id="loginForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
        <div class="pass-wrap">
          <input class="form-input" id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
          <button class="pass-toggle" onclick="togglePass('loginPass',this)" tabindex="-1">ğŸ‘</button>
        </div>
      </div>
      <a class="forgot" onclick="forgotPassword()">Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?</a>
      <button class="btn-primary" onclick="doLogin()" id="btnLogin">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    </div>

    <!-- Register form -->
    <div id="registerForm" style="display:none">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="regEmail" type="email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
        <div class="pass-wrap">
          <input class="form-input" id="regPass" type="password" placeholder="ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²" autocomplete="new-password">
          <button class="pass-toggle" onclick="togglePass('regPass',this)" tabindex="-1">ğŸ‘</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</label>
        <div class="pass-wrap">
          <input class="form-input" id="regPass2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
          <button class="pass-toggle" onclick="togglePass('regPass2',this)" tabindex="-1">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-primary" onclick="doRegister()" id="btnRegister">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
    </div>

    <div class="footer">Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚ Â· <a href="index.html">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</a></div>
  </div>

  <!-- â•â• SCREEN: VERIFY EMAIL â•â• -->
  <div class="screen" id="screenVerify">
    <div class="verify-icon">ğŸ“¬</div>
    <div class="screen-title">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ email</div>
    <div class="screen-sub" id="verifySubtext">ĞœÑ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ²Ğ°Ñˆ Ğ°Ğ´Ñ€ĞµÑ.</div>
    <div id="verifyErr" class="err-box"></div>
    <button class="btn-primary" onclick="checkVerified()" id="btnVerified">Ğ¯ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ» âœ“</button>
    <button class="btn-secondary" onclick="resendVerification()">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾</button>
    <button class="btn-secondary" style="margin-top:4px;color:var(--text3);border-color:transparent" onclick="backToAuth()">â† ĞĞ°Ğ·Ğ°Ğ´</button>
  </div>

  <!-- â•â• SCREEN: SETUP ACCOUNT â•â• -->
  <div class="screen" id="screenSetup">
    <div class="screen-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</div>
    <div class="screen-sub">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ°</div>
    <div id="setupErr" class="err-box"></div>

    <div class="form-group">
      <label class="form-label">Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ</label>
      <input class="form-input" id="setupName" type="text" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ‘Ğ¾Ğ³Ğ´Ğ°Ğ½">
    </div>
    <div class="form-group">
      <label class="form-label">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°</label>
      <input class="form-input" id="setupAccName" type="text" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¡ĞµĞ¼ÑŒÑ ĞšĞ¾Ğ²Ğ°Ğ»ÑŒÑĞºĞ¸Ñ…">
    </div>
    <div class="form-group">
      <label class="form-label">Ğ¦Ğ²ĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°</label>
      <div class="avatar-row" id="colorPicker"></div>
    </div>
    <button class="btn-primary" onclick="doSetupAccount()" id="btnSetup" style="margin-top:8px">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ â†’</button>
  </div>

  <!-- â•â• SCREEN: JOIN ACCOUNT â•â• -->
  <div class="screen" id="screenJoin">
    <div class="screen-title">Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!</div>
    <div class="screen-sub" id="joinSubtext">Ğ’Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»Ğ¸ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚. ĞŸÑ€Ğ¸Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.</div>
    <div id="joinErr" class="err-box"></div>
    <div class="form-group">
      <label class="form-label">Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ</label>
      <input class="form-input" id="joinName" type="text" placeholder="ĞšĞ°Ğº Ğ²Ğ°Ñ Ğ½Ğ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ?">
    </div>
    <div class="form-group">
      <label class="form-label">Ğ¦Ğ²ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</label>
      <div class="avatar-row" id="joinColorPicker"></div>
    </div>
    <button class="btn-primary" onclick="doJoinAccount()" id="btnJoin">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ â†’</button>
  </div>

</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FB_CONFIG = {
  apiKey: "AIzaSyBZ1b6yf1WQbhZ7lhIbeYw_fKc4k88mmFc",
  authDomain: "family-budget-32149.firebaseapp.com",
  databaseURL: "https://family-budget-32149-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "family-budget-32149",
  storageBucket: "family-budget-32149.firebasestorage.app",
  messagingSenderId: "709889158014",
  appId: "1:709889158014:web:placeholder"
};

firebase.initializeApp(FB_CONFIG);
const auth = firebase.auth();
const db   = firebase.database();

// Sign out on every page load â€” user must explicitly login
auth.signOut().catch(()=>{});

const COLORS = ['#6c8dfa','#4ecca3','#ff87b2','#ffa94d','#b197fc','#ffd43b','#ff6b6b','#38bdf8','#34d399','#f472b6'];
let _selColor = COLORS[0];
let _joinSelColor = COLORS[0];
let _pendingUser = null;

// â”€â”€ Init color pickers â”€â”€
function initColorPicker(containerId, onSelect){
  const el = document.getElementById(containerId);
  if(!el) return;
  el.innerHTML = COLORS.map((c,i) =>
    `<div class="av-color${i===0?' selected':''}" style="background:${c}" onclick="pickColor('${containerId}','${c}',this)"></div>`
  ).join('');
}
function pickColor(containerId, color, el){
  document.querySelectorAll(`#${containerId} .av-color`).forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  if(containerId==='colorPicker') _selColor=color;
  else _joinSelColor=color;
}
initColorPicker('colorPicker');
initColorPicker('joinColorPicker');

// No auto-redirect â€” user must explicitly login each time

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('loginForm').style.display   = tab==='login'    ? 'block':'none';
  document.getElementById('registerForm').style.display= tab==='register' ? 'block':'none';
  hideErr(); hideInfo();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showErr(msg, boxId='errBox'){
  const el=document.getElementById(boxId);
  el.textContent=msg; el.style.display='block';
}
function hideErr(boxId='errBox'){ document.getElementById(boxId).style.display='none'; }
function showInfo(msg){ const el=document.getElementById('infoBox'); el.textContent=msg; el.style.display='block'; }
function hideInfo(){ document.getElementById('infoBox').style.display='none'; }
function setLoading(btnId, loading, text=''){
  const btn=document.getElementById(btnId);
  btn.disabled=loading;
  btn.innerHTML=loading ? `<span class="spinner"></span>ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...` : text;
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function togglePass(inputId, btn){
  const inp=document.getElementById(inputId);
  inp.type = inp.type==='password'?'text':'password';
  btn.textContent = inp.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}
function backToAuth(){ auth.signOut(); showScreen('screenAuth'); }

function goToApp(accId){
  // Sign out from Firebase before going to app (finflow-pro has its own auth)
  auth.signOut().finally(() => {
    window.location.href = 'index.html';
  });
}

function firebaseErrMsg(code){
  const msgs = {
    'auth/email-already-in-use':   'Ğ­Ñ‚Ğ¾Ñ‚ email ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½',
    'auth/invalid-email':          'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ email',
    'auth/weak-password':          'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)',
    'auth/user-not-found':         'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
    'auth/wrong-password':         'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ',
    'auth/invalid-credential':     'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ email Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ',
    'auth/too-many-requests':      'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ',
    'auth/network-request-failed': 'ĞĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº ÑĞµÑ‚Ğ¸',
    'auth/user-disabled':          'ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½',
  };
  return msgs[code] || 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + code;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  hideErr(); hideInfo();
  if(!email || !pass){ showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ'); return; }

  setLoading('btnLogin', true);
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const user = cred.user;

    if(!user.emailVerified){
      _pendingUser = user;
      document.getElementById('verifySubtext').textContent =
        `ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ email ${email} Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸.`;
      showScreen('screenVerify');
      setLoading('btnLogin', false, 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸');
      return;
    }

    // Check if user account is set up
    const snap = await db.ref('finflow_users/' + user.uid).once('value');
    if(snap.val()){
      goToApp(snap.val().accId);
    } else {
      // Invited but never set up name
      _pendingUser = user;
      await checkInvite(user);
    }
  } catch(e) {
    showErr(firebaseErrMsg(e.code));
    setLoading('btnLogin', false, 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸');
  }
}

// Enter key on login
document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('loginEmail').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REGISTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister(){
  const email = document.getElementById('regEmail').value.trim();
  const pass  = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  hideErr();

  if(!email)       { showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email'); return; }
  if(!pass)        { showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ'); return; }
  if(pass.length<6){ showErr('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²'); return; }
  if(pass!==pass2) { showErr('ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚'); return; }

  setLoading('btnRegister', true);
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const user = cred.user;

    // Send verification email
    await user.sendEmailVerification({
      url: window.location.href
    });

    _pendingUser = user;
    document.getElementById('verifySubtext').textContent =
      `ĞŸĞ¸ÑÑŒĞ¼Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ½Ğ° ${email}. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ.`;
    showScreen('screenVerify');
    setLoading('btnRegister', false, 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚');
  } catch(e) {
    showErr(firebaseErrMsg(e.code));
    setLoading('btnRegister', false, 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VERIFY EMAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkVerified(){
  hideErr('verifyErr');
  setLoading('btnVerified', true);
  try {
    await auth.currentUser.reload();
    const user = auth.currentUser;
    if(user.emailVerified){
      // Check if invited
      const invSnap = await db.ref('finflow_invites').orderByChild('email').equalTo(user.email).once('value');
      const invData = invSnap.val();
      if(invData){
        // Has invite â€” go to join screen
        _pendingUser = user;
        _pendingInvite = Object.entries(invData)[0];
        await showJoinScreen();
      } else {
        // New user â€” go to setup
        showScreen('screenSetup');
        document.getElementById('setupAccName').focus();
      }
    } else {
      showErr('Email ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ.', 'verifyErr');
    }
  } catch(e) {
    showErr(firebaseErrMsg(e.code), 'verifyErr');
  }
  setLoading('btnVerified', false, 'Ğ¯ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ» âœ“');
}

async function resendVerification(){
  try {
    await auth.currentUser.sendEmailVerification({ url: window.location.href });
    document.getElementById('verifyErr').style.display='none';
    const el=document.getElementById('infoBox');
    // Show in verify screen area
    const info=document.createElement('div');
    info.style.cssText='color:var(--accent2);font-size:13px;text-align:center;margin-top:12px;';
    info.textContent='âœ… ĞŸĞ¸ÑÑŒĞ¼Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾';
    document.getElementById('screenVerify').appendChild(info);
    setTimeout(()=>info.remove(), 3000);
  } catch(e) {
    showErr(firebaseErrMsg(e.code), 'verifyErr');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP NEW ACCOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSetupAccount(){
  const name    = document.getElementById('setupName').value.trim();
  const accName = document.getElementById('setupAccName').value.trim();
  hideErr('setupErr');

  if(!name)    { showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ', 'setupErr'); return; }
  if(!accName) { showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°', 'setupErr'); return; }

  setLoading('btnSetup', true);
  try {
    const user  = auth.currentUser;
    const accId = 'acc_' + user.uid.slice(0,8);
    const uid   = 'u_' + user.uid.slice(0,8);

    // Create account in finflow_meta
    await db.ref('finflow_meta/' + accId).set({
      name:  accName,
      color: _selColor,
      owner: user.uid,
      users: {
        [uid]: {
          name:     name,
          email:    user.email,
          role:     'admin',
          color:    _selColor,
          uid:      user.uid,
          password: '1234',
        }
      }
    });

    // Create user index
    await db.ref('finflow_users/' + user.uid).set({
      accId: accId,
      userId: uid,
      name:  name,
      email: user.email,
      role:  'admin',
    });

    goToApp(accId);
  } catch(e) {
    showErr('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message, 'setupErr');
    setLoading('btnSetup', false, 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ â†’');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVITE / JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pendingInvite = null;

async function checkInvite(user){
  const invSnap = await db.ref('finflow_invites').orderByChild('email').equalTo(user.email).once('value');
  const invData = invSnap.val();
  if(invData){
    _pendingInvite = Object.entries(invData)[0];
    await showJoinScreen();
  } else {
    // No invite â€” show setup
    showScreen('screenSetup');
  }
}

async function showJoinScreen(){
  const [invId, inv] = _pendingInvite;
  const accSnap = await db.ref('finflow_meta/' + inv.accId + '/name').once('value');
  const accName = accSnap.val() || 'Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚';
  document.getElementById('joinSubtext').textContent =
    `Ğ’Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»Ğ¸ Ğ² Â«${accName}Â». ĞšĞ°Ğº Ğ²Ğ°Ñ Ğ½Ğ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ?`;
  showScreen('screenJoin');
}

async function doJoinAccount(){
  const name = document.getElementById('joinName').value.trim();
  hideErr('joinErr');
  if(!name){ showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ', 'joinErr'); return; }

  setLoading('btnJoin', true);
  try {
    const user = auth.currentUser;
    const [invId, inv] = _pendingInvite;

    // Use existing userId if migrating, or create new one
    const uid = inv.userId || ('u_' + user.uid.slice(0,8));
    const isMigration = !!inv.userId; // existing user being migrated

    if(isMigration){
      // Migration: only update uid and email, preserve all other data
      await db.ref('finflow_meta/' + inv.accId + '/users/' + uid + '/uid').set(user.uid);
      await db.ref('finflow_meta/' + inv.accId + '/users/' + uid + '/email').set(user.email);
    } else {
      // New user: create full record
      await db.ref('finflow_meta/' + inv.accId + '/users/' + uid).set({
        name:     name,
        email:    user.email,
        role:     inv.role || 'editor',
        color:    _joinSelColor,
        uid:      user.uid,
        password: '1234',
      });
    }

    // Create user index â€” links Firebase Auth uid to account
    await db.ref('finflow_users/' + user.uid).set({
      accId:  inv.accId,
      userId: uid,
      name:   inv.userName || name,
      email:  user.email,
      role:   inv.role || 'editor',
    });

    // Remove invite
    await db.ref('finflow_invites/' + invId).remove();

    goToApp(inv.accId);
  } catch(e) {
    showErr('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message, 'joinErr');
    setLoading('btnJoin', false, 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ â†’');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORGOT PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function forgotPassword(){
  const email = document.getElementById('loginEmail').value.trim();
  hideErr(); hideInfo();
  if(!email){ showErr('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    showInfo(`âœ… ĞŸĞ¸ÑÑŒĞ¼Ğ¾ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ½Ğ° ${email}`);
  } catch(e) {
    showErr(firebaseErrMsg(e.code));
  }
}
</script>
</body>
</html>
